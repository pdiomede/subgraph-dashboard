<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Subgraph Repositories Dashboard</title>
  <style>
    body { font-family: sans-serif; background: #f9f9f9; padding: 2rem; color: #333; }
    h1 { color: #222; margin-bottom: 0.2rem; }
    h2, h3 { font-weight: normal; margin-top: 0; color: #666; }
    .summary, .generated { margin-bottom: 1rem; font-size: 1rem; color: #555; }
    table { border-collapse: collapse; width: 100%; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    th, td { padding: 0.75rem; border: 1px solid #ddd; text-align: left; font-size: 0.95rem; }
    th { cursor: pointer; background: #f0f0f0; }
    tr:hover { background-color: #f5f5f5; }
    input { margin-bottom: 1rem; padding: 0.5rem; width: 250px; border: 1px solid #ccc; border-radius: 4px; }
    .filter-container { margin-bottom: 1.5rem; }
    .pagination { margin-top: 1rem; text-align: center; }
    .pagination button { margin: 0 4px; padding: 0.4rem 0.7rem; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    .pagination button.active { font-weight: bold; background: #eee; }
    .contributors { margin-bottom: 2rem; }
    .contributors ul { padding-left: 1.2rem; }
  </style>
</head>
<body>
  <h1>📊 Subgraph Repositories Dashboard</h1>
  <h2>Tracking public subgraph.yaml/.yml usage on GitHub</h2>
  <div class="summary" id="summary"></div>
  <div class="generated" id="generated"></div>

  <div class="contributors">
    <h3>🌟 Top 10 Contributors (by number of repos)</h3>
    <ul id="topContributors"></ul>
  </div>

  <div class="filter-container">
    <input type="text" id="search" placeholder="🔍 Filter by owner..." onkeyup="filterTable()" />
  </div>

  <table id="repoTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">Repository</th>
        <th onclick="sortTable(1)">Owner</th>
        <th onclick="sortTable(2)">Stars</th>
        <th onclick="sortTable(3)">Last Updated</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="pagination" id="pagination"></div>

  <script>
    let allRows = [];
    let currentPage = 1;
    const rowsPerPage = 50;

    async function loadCSV() {
      const response = await fetch('subgraph_repositories_filtered.csv');
      const text = await response.text();
      const rows = text.trim().split('\n');
      const headers = rows[0].split(',');
      const dataRows = rows.slice(1);
      const tbody = document.querySelector("tbody");

      let lastUpdated = "N/A";
      const contributors = {};

      allRows = dataRows.map(row => {
        const cols = row.split(',');
        lastUpdated = cols[5] > lastUpdated ? cols[5] : lastUpdated;
        contributors[cols[2]] = (contributors[cols[2]] || 0) + 1;
        return \`
          <tr>
            <td><a href="\${cols[1]}" target="_blank">\${cols[0]}</a></td>
            <td><a href="https://github.com/\${cols[2]}" target="_blank">\${cols[2]}</a></td>
            <td>\${cols[4]}</td>
            <td>\${cols[5]}</td>
            <td>\${cols[3]}</td>
          </tr>\`;
      });

      document.getElementById("summary").innerText =
        \`📦 Total repositories: \${allRows.length} | 🕒 Latest update: \${lastUpdated}\`;

      const now = new Date().toLocaleString();
      document.getElementById("generated").innerText =
        \`📅 Report generated on: \${now}\`;

      const topContribs = Object.entries(contributors)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([owner, count]) => \`<li><a href="https://github.com/\${owner}" target="_blank">\${owner}</a> — \${count} repos</li>\`);
      document.getElementById("topContributors").innerHTML = topContribs.join("");

      sortTable(2, true);
      displayPage(1);
      renderPagination();
    }

    function sortTable(colIndex, descending = false) {
      allRows.sort((a, b) => {
        const tdA = a.match(/<td.*?>(.*?)<\/td>/g)[colIndex].replace(/<[^>]+>/g, '');
        const tdB = b.match(/<td.*?>(.*?)<\/td>/g)[colIndex].replace(/<[^>]+>/g, '');
        const numA = parseFloat(tdA) || 0;
        const numB = parseFloat(tdB) || 0;
        return descending ? numB - numA : numA - numB;
      });
    }

    function filterTable() {
      const value = document.getElementById("search").value.toLowerCase();
      const filtered = allRows.filter(row => row.toLowerCase().includes(value));
      currentPage = 1;
      displayPage(currentPage, filtered);
      renderPagination(filtered.length);
    }

    function displayPage(page, data = allRows) {
      currentPage = page;
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const tbody = document.querySelector("tbody");
      tbody.innerHTML = data.slice(start, end).join('');
    }

    function renderPagination(length = allRows.length) {
      const totalPages = Math.ceil(length / rowsPerPage);
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        pagination.innerHTML += \`<button onclick="displayPage(\${i})" class="\${i === currentPage ? 'active' : ''}">\${i}</button>\`;
      }
    }

    loadCSV();
  </script>
</body>
</html>
